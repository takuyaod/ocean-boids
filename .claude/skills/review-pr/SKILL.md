# PR レビュースキル

指定した PR に対して、複数の観点から並列でレビューを行い、統合レポートを出力します。

## 使い方

```
/review-pr <PR番号>
```

## 手順

1. `$ARGUMENTS` から PR 番号を取得する
2. `gh` CLI で PR の情報と差分を取得する
3. 複数のサブエージェントを **並列** で起動し、各観点からレビューを実施する
4. 全サブエージェントの結果を統合して Markdown 形式でレポートを出力する

## 実行

### PR 番号の確認

`$ARGUMENTS` が空の場合は、PR 番号をユーザーに尋ねてください。

### 事前確認

`gh` CLI のインストールと認証状態を確認してください。

```bash
gh auth status
```

エラーが返った場合は、`gh auth login` での認証を促してレビューを中断してください。

### PR 情報の取得

```bash
gh pr view <PR番号> --json number,title,body,author,baseRefName,headRefName,additions,deletions,changedFiles
```

`gh pr view` がエラーを返した場合（PR番号が不正・リポジトリが見つからない等）は、エラー内容をユーザーに伝えてレビューを中断してください。

続いて差分を取得します。

```bash
gh pr diff <PR番号>
```

取得した `additions` と `deletions` の合計が **2,000行を超える場合**は、以下のメッセージをユーザーに表示してください：

```
⚠️ この PR の差分は非常に大きいです（+<additions> / -<deletions> 行）。
レビューに時間とトークンが多くかかる可能性があります。続行しますか？ [y/N]
```

ユーザーが続行しない場合はレビューを中断してください。

### サブエージェントの並列起動

Task ツールを使用して、以下の6つのサブエージェントを **同時に（1つのメッセージで）** 起動してください。
各エージェントには PR の差分全文と PR の概要情報を渡します。

#### エージェント1: コード品質レビュー

```
以下のPR差分をレビューしてください。

## レビュー観点: コード品質
- 可読性（変数名・関数名の明確さ、コードの簡潔さ）
- 命名規則の一貫性（プロジェクトの既存スタイルへの準拠）
- 重複コードの有無
- 関数・クラスの複雑度（ネストの深さ、関数の長さ）

## 出力フォーマット
以下の形式で回答してください：

### コード品質
**評価**: [問題なし / 軽微な問題あり / 要修正]

<具体的なフィードバック。問題がある場合はファイル名と行番号を明記>

**必須修正**:
- <必須の修正点があれば箇条書き、なければ「なし」>

**推奨改善**:
- <推奨の改善点があれば箇条書き、なければ「なし」>

**良い点**:
- <良い点があれば箇条書き、なければ「なし」>

## PR情報
<PR情報と差分をここに渡す>
```

#### エージェント2: セキュリティレビュー

```
以下のPR差分をレビューしてください。

## レビュー観点: セキュリティ
- 脆弱性（XSS、CSRF、SQLインジェクション等のOWASP Top 10）
- インジェクション攻撃への脆弱性
- 機密情報（APIキー、パスワード、トークン）のハードコード
- 認証・認可の不備
- 安全でない依存関係の追加

## 出力フォーマット
以下の形式で回答してください：

### セキュリティ
**評価**: [問題なし / 軽微な問題あり / 要修正]

<具体的なフィードバック。問題がある場合はファイル名と行番号を明記>

**必須修正**:
- <必須の修正点があれば箇条書き、なければ「なし」>

**推奨改善**:
- <推奨の改善点があれば箇条書き、なければ「なし」>

**良い点**:
- <良い点があれば箇条書き、なければ「なし」>

## PR情報
<PR情報と差分をここに渡す>
```

#### エージェント3: パフォーマンスレビュー

```
以下のPR差分をレビューしてください。

## レビュー観点: パフォーマンス
- アルゴリズムの計算量（O(n²)以上になっていないか）
- React コンポーネントの不要な再レンダリング（useMemo, useCallback の欠如）
- メモリリークの可能性（イベントリスナーの未解除、非同期処理のキャンセル漏れ）
- 不要なデータ取得・重複リクエスト
- 重い処理の同期実行

## 出力フォーマット
以下の形式で回答してください：

### パフォーマンス
**評価**: [問題なし / 軽微な問題あり / 要修正]

<具体的なフィードバック。問題がある場合はファイル名と行番号を明記>

**必須修正**:
- <必須の修正点があれば箇条書き、なければ「なし」>

**推奨改善**:
- <推奨の改善点があれば箇条書き、なければ「なし」>

**良い点**:
- <良い点があれば箇条書き、なければ「なし」>

## PR情報
<PR情報と差分をここに渡す>
```

#### エージェント4: 型安全性レビュー

```
以下のPR差分をレビューしてください。

## レビュー観点: 型安全性（TypeScript）
- `any` 型の不適切な使用（`unknown` 型への置き換えが可能な箇所を含む）
- 型定義の不足・不正確さ
- 型アサーション（as）の過剰使用
- null / undefined の安全でない取り扱い
- 型の整合性（引数・戻り値の型が正しいか）
- strict モードとの整合性
- Next.js App Router 固有の型パターン（`params` / `searchParams` の `Promise<>` ラップ、Server Component と Client Component の型境界）

## 出力フォーマット
以下の形式で回答してください：

### 型安全性
**評価**: [問題なし / 軽微な問題あり / 要修正]

<具体的なフィードバック。問題がある場合はファイル名と行番号を明記>

**必須修正**:
- <必須の修正点があれば箇条書き、なければ「なし」>

**推奨改善**:
- <推奨の改善点があれば箇条書き、なければ「なし」>

**良い点**:
- <良い点があれば箇条書き、なければ「なし」>

## PR情報
<PR情報と差分をここに渡す>
```

#### エージェント5: アーキテクチャレビュー

```
以下のPR差分をレビューしてください。

## レビュー観点: アーキテクチャ
- 責務の分離（単一責任の原則への準拠）
- プロジェクト構成への準拠（CLAUDE.md の規約、App Router の規約）
- コンポーネント・モジュールの適切な分割
- 依存関係の方向（循環依存がないか）
- 再利用性と拡張性

## 出力フォーマット
以下の形式で回答してください：

### アーキテクチャ
**評価**: [問題なし / 軽微な問題あり / 要修正]

<具体的なフィードバック。問題がある場合はファイル名と行番号を明記>

**必須修正**:
- <必須の修正点があれば箇条書き、なければ「なし」>

**推奨改善**:
- <推奨の改善点があれば箇条書き、なければ「なし」>

**良い点**:
- <良い点があれば箇条書き、なければ「なし」>

## PR情報
<PR情報と差分をここに渡す>
```

#### エージェント6: テストレビュー

```
以下のPR差分をレビューしてください。

## レビュー観点: テスト
- テストの有無（新機能・バグ修正に対応するテストが追加されているか）
- テストカバレッジ（正常系・異常系・エッジケースの網羅）
- テストの品質（テストが実際に意味のある検証をしているか）
- テストの独立性（他のテストに依存していないか）
- モックの適切な使用

注意: プロジェクトにテストフレームワークが未設定の場合は、その旨を明記した上でテスト導入の推奨コメントを添えてください。

## 出力フォーマット
以下の形式で回答してください：

### テスト
**評価**: [問題なし / 軽微な問題あり / 要修正 / テスト未設定]

<具体的なフィードバック。問題がある場合はファイル名と行番号を明記>

**必須修正**:
- <必須の修正点があれば箇条書き、なければ「なし」>

**推奨改善**:
- <推奨の改善点があれば箇条書き、なければ「なし」>

**良い点**:
- <良い点があれば箇条書き、なければ「なし」>

## PR情報
<PR情報と差分をここに渡す>
```

### 結果の統合とレポート出力

全サブエージェントの結果を受け取ったら、以下のフォーマットで統合レポートを出力してください。

```markdown
## PRレビュー結果 #<PR番号>

**タイトル**: <PRタイトル>
**作成者**: <作成者>
**変更**: +<additions> / -<deletions> 行、<changedFiles> ファイル

---

### 総合評価: <LGTM / 要修正 / 要議論>

> 総合評価の根拠を1〜2文で説明

---

### コード品質
<エージェント1の結果>

---

### セキュリティ
<エージェント2の結果>

---

### パフォーマンス
<エージェント3の結果>

---

### 型安全性
<エージェント4の結果>

---

### アーキテクチャ
<エージェント5の結果>

---

### テスト
<エージェント6の結果>

---

### まとめ

**必須修正**:
- <全エージェントの必須修正を集約。なければ「なし」>

**推奨改善**:
- <全エージェントの推奨改善を集約。なければ「なし」>

**良い点**:
- <全エージェントの良い点を集約。なければ「なし」>
```

### 総合評価の基準

- **LGTM**: 全観点で「問題なし」または「軽微な問題あり」のみ（「テスト未設定」は除外して判定）
- **要修正**: 1つ以上の観点で「要修正」と評価された
- **要議論**: 「要修正」は0件だが、1つ以上の観点で「要議論」と判断された（設計上の重要な判断を含む変更がある場合）

複数の評価が混在する場合の優先順位: **要修正 > 要議論 > LGTM**
